<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust&#39;s State Machine &amp; Iterators: Conquering Nested Data&#39;s Missing Pieces</title>
    <meta name="description" content="jcsherin writes about programming">
    <meta name="generator" content="Eleventy v1.0.1">

    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="stylesheet" href="/css/prism-diff.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="jcsherin">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="jcsherin">
  </head>
  <body>
    <div class="page-wrapper">
      <header>
        <h1 class="home"><a href="/">jcsherin</a></h1>
        <ul class="nav">
          <li class="nav-item"><a href="/">Writings</a></li>
          <li class="nav-item"><a href="/about/">About</a></li>
        </ul>
      </header>
      <h4 class="page-subtitle">Bridging Theory and Practice: Exploring Analytical Query Execution with Apache DataFusion, Parquet, and Apache Arrow</h4>

      <main class="tmpl-post">
        <h1>Rust&#39;s State Machine &amp; Iterators: Conquering Nested Data&#39;s Missing Pieces</h1>

<time datetime="2025-06-18">18 Jun 2025</time>


  <div class="draft-indicator">
    <p><strong>DRAFT</strong></p>
    <p>This is a draft preview. To publish, remove draft: true from the front matter.</p>
  </div>


<h2 id="introduction" tabindex="-1">Introduction <a class="direct-link" href="#introduction" aria-hidden="true">#</a></h2>
<p>Welcome back to our series on record shredding! In previous posts, we laid the groundwork by exploring the core
challenge of representing <strong>nested data</strong> efficiently in columnar storage and introduced <strong>Dremel's revolutionary
solution</strong>, leveraging definition and repetition levels. Today, we're taking a deep dive into <strong>denester</strong>, a Rust
implementation that brings Dremel's powerful concepts to life.</p>
<p>The seemingly straightforward task of implementing Dremel's shredding algorithm, especially when dealing with the subtle
but critical nuances of <strong>missing or sparse values</strong>, presents unique difficulties. It's not just about traversing a
tree; it's about correctly inferring and injecting &quot;null&quot; values and maintaining order. Our solution to this complexity
lies in a robust, decoupled <strong>iterator and state machine</strong> architecture, which we'll unpack in detail.</p>
<h2 id="the-denester-blueprint:-schema-and-values" tabindex="-1">The denester Blueprint: Schema and Values <a class="direct-link" href="#the-denester-blueprint:-schema-and-values" aria-hidden="true">#</a></h2>
<p>Before we shred, we need a clear understanding of what we're shredding. denester relies on explicit representations for
both the data's structure (schema) and its content (values).</p>
<h3 id="schema-definition" tabindex="-1">Schema Definition <a class="direct-link" href="#schema-definition" aria-hidden="true">#</a></h3>
<p>The schema defines the structure of your nested data. In denester, this is primarily managed through the <code>DataType</code> and
<code>Field</code> enums.</p>
<p>Here's a concise look at the <code>DataType</code> enum:</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// src/field.rs</span><br><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">DataType</span> <span class="token punctuation">{</span><br>  <span class="token comment">// ... basic types like Int32, ByteArray, etc.</span><br>  <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token class-name">Schema</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// For nested structs/groups</span><br>  <span class="token class-name">List</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Field</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// For repeated fields/lists</span><br><span class="token punctuation">}</span></code></pre>
<p>Building a schema is intuitive with SchemaBuilder:</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// src/schema.rs or tests/schema.rs</span><br><span class="token keyword">use</span> <span class="token namespace">denester<span class="token punctuation">::</span>schema<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Schema</span><span class="token punctuation">,</span> <span class="token class-name">SchemaBuilder</span><span class="token punctuation">,</span> <span class="token class-name">Field</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">let</span> schema <span class="token operator">=</span> <span class="token class-name">SchemaBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">.</span><span class="token function">add_field</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">Int32</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">.</span><span class="token function">add_field</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">.</span><span class="token function">add_field</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"addresses"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><br><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">Group</span><span class="token punctuation">(</span><br><span class="token class-name">SchemaBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">.</span><span class="token function">add_field</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"street"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">.</span><span class="token function">add_field</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"zip"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">Int32</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Optional field</span><br><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Optional list</span><br><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="value-representation" tabindex="-1">Value Representation <a class="direct-link" href="#value-representation" aria-hidden="true">#</a></h3>
<p>Input data is represented using the Value enum, which can encapsulate primitives, nested structs, or lists.</p>
<p>A concise code snippet for the Value enum:</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// src/value.rs</span><br><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Value</span> <span class="token punctuation">{</span><br>  <span class="token class-name">Null</span><span class="token punctuation">,</span><br>  <span class="token class-name">Bool</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token class-name">Int32</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token comment">// ... other primitive types</span><br>  <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// For structs/objects</span><br>  <span class="token class-name">List</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// For arrays/lists</span><br><span class="token punctuation">}</span></code></pre>
<p>Creating complex nested data with ValueBuilder is straightforward:</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// src/value.rs or benches/shredder.rs</span><br><span class="token keyword">use</span> <span class="token namespace">denester<span class="token punctuation">::</span>value<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Value</span><span class="token punctuation">,</span> <span class="token class-name">ValueBuilder</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">let</span> nested_value <span class="token operator">=</span> <span class="token class-name">ValueBuilder</span><span class="token punctuation">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">Int32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"Alice"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"addresses"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><br>  <span class="token class-name">ValueBuilder</span><span class="token punctuation">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"street"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"123 Main St"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"zip"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">Int32</span><span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token class-name">ValueBuilder</span><span class="token punctuation">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"street"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"456 Oak Ave"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token comment">// zip is missing here, important for testing missing data!</span><br>    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="the-core-problem:-beyond-simple-recursive-traversal" tabindex="-1">The Core Problem: Beyond Simple Recursive Traversal <a class="direct-link" href="#the-core-problem:-beyond-simple-recursive-traversal" aria-hidden="true">#</a></h3>
<p>While simple recursive approaches excel at basic tree traversal, Dremel shredding, especially with sparse data, presents
a significant challenge. A naive recursion falls short for several reasons:</p>
<p>Generating nulls for missing optional fields: If an optional field is absent in the input, Dremel requires a &quot;null&quot;
value with specific definition and repetition levels. A simple recursion won't naturally generate these.</p>
<p>Handling empty repeated lists: An empty list should still produce a record with appropriate levels, not just be skipped.</p>
<p>Maintaining correct output order: When we inject these &quot;synthetic&quot; nulls, they must appear in the correct columnar order
relative to the actual present values.</p>
<p>This highlights that a more explicit state management and output buffering strategy is absolutely required. We need
fine-grained control over when values are emitted and when missing paths are accounted for.</p>
<h3 id="valueparser:-the-iterative-state-machine" tabindex="-1">ValueParser: The Iterative State Machine <a class="direct-link" href="#valueparser:-the-iterative-state-machine" aria-hidden="true">#</a></h3>
<p>Enter ValueParser, the central component responsible for shredding. It's not just a parser; it's an iterative state
machine designed to navigate the complexities of Dremel.</p>
<h4 id="high-level-architecture" tabindex="-1">High-Level Architecture <a class="direct-link" href="#high-level-architecture" aria-hidden="true">#</a></h4>
<p>ValueParser decouples the traversal of the input Value from the processing and emission of shredded records.</p>
<p>value_iter (DepthFirstValueIterator): This component is the source of present input values. It performs a depth-first
traversal of the Value tree.</p>
<p>work_queue: This is the crucial element for decoupling. It acts as an internal buffer for items that are ready to be
processed and emitted, including both actual values and generated &quot;missing&quot; values.</p>
<p>Here's a glimpse into the ValueParser and WorkItem definitions:</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// src/parser.rs</span><br><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ValueParser</span> <span class="token punctuation">{</span><br>  <span class="token comment">// ...</span><br>  value_iter<span class="token punctuation">:</span> <span class="token class-name">DepthFirstValueIterator</span><span class="token punctuation">,</span><br>  work_queue<span class="token punctuation">:</span> <span class="token class-name">VecDeque</span><span class="token operator">&lt;</span><span class="token class-name">WorkItem</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// Crucial for buffering and ordering</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">WorkItem</span> <span class="token punctuation">{</span><br>  <span class="token class-name">Value</span><span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token class-name">MissingField</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Represents a schema field that was missing in the input</span><br>  <span class="token comment">// ... other internal states</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="state-management:-knowing-where-you-are-(and-what's-missing)" tabindex="-1">State Management: Knowing Where You Are (and What's Missing) <a class="direct-link" href="#state-management:-knowing-where-you-are-(and-what's-missing)" aria-hidden="true">#</a></h3>
<p>To correctly compute definition and repetition levels, ValueParser meticulously tracks its position within the schema
and input data using several internal context structures, managed on internal stacks.</p>
<ul>
<li><code>LevelContext</code>: This context accumulates the definition and repetition levels as the parser descends into the nested
structure. It's fundamental for Dremel's output.</li>
</ul>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// src/parser.rs</span><br><span class="token attribute attr-name">#[derive(Debug, Clone)]</span><br><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">LevelContext</span> <span class="token punctuation">{</span><br>  <span class="token keyword">pub</span> def_level<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span><br>  <span class="token keyword">pub</span> rep_level<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span><br>  <span class="token comment">// ... other context for the current level</span><br><span class="token punctuation">}</span></code></pre>
<ul>
<li><code>RepetitionContext</code>: This specifically tracks positions within lists (repeated fields). It helps determine when a new
repetition level is needed.</li>
</ul>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// src/parser.rs</span><br><span class="token attribute attr-name">#[derive(Debug, Clone)]</span><br><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">RepetitionContext</span> <span class="token punctuation">{</span><br>  <span class="token keyword">pub</span> current_index<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span><br>  <span class="token keyword">pub</span> total_items<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
<ul>
<li><code>StructContext</code>: This manages the schema fields at the current structural depth (within a struct or group), which is
vital for identifying missing fields.</li>
</ul>
<p>These contexts are pushed onto and popped from internal stacks as the ValueParser traverses the input data, providing a
precise understanding of the current shredding context.</p>
<h1 id="handling-missing-data:-the-&quot;unhappy-path&quot;" tabindex="-1">Handling Missing Data: The &quot;Unhappy Path&quot; <a class="direct-link" href="#handling-missing-data:-the-&quot;unhappy-path&quot;" aria-hidden="true">#</a></h1>
<p>This is where denester truly shines. Correctly handling missing or sparse data is paramount for Dremel's guarantees.</p>
<hr>
<h2 id="identifying-gaps" tabindex="-1">Identifying Gaps <a class="direct-link" href="#identifying-gaps" aria-hidden="true">#</a></h2>
<p>As <strong>ValueParser</strong> traverses the actual input <strong>Value</strong> using <code>value_iter</code>, it constantly compares the present data
against the defined schema. The <code>buffer_missing_paths</code> mechanism identifies schema-defined fields that are absent in the
input value at the current structural level.</p>
<hr>
<h2 id="strategic-buffering" tabindex="-1">Strategic Buffering <a class="direct-link" href="#strategic-buffering" aria-hidden="true">#</a></h2>
<p>Crucially, these identified missing paths are <strong>buffered</strong> rather than immediately queued for processing. Why? Because
their exact position in the output stream depends on the traversal. If we immediately queued them, they might appear out
of order relative to sibling fields that are present.</p>
<hr>
<h2 id="queuing-logic-on-traversal-backtrack:-the-key-insight" tabindex="-1">Queuing Logic on Traversal Backtrack: The Key Insight <a class="direct-link" href="#queuing-logic-on-traversal-backtrack:-the-key-insight" aria-hidden="true">#</a></h2>
<p>The pivotal insight is that buffered missing paths are pushed to the <code>work_queue</code> only when <code>value_iter</code> signals a
transition to a sibling or an ancestor. This indicates that all children of the current node have been processed (or
accounted for as missing), and it's time to emit any pending missing fields for that level before moving to the next
sibling or ascending the tree.</p>
<p>This ensures that &quot;synthetic&quot; nulls for missing optional fields are correctly interleaved with actual data, maintaining
the precise columnar order required by Dremel.</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// Simplified logic from ValueParser::next demonstrating buffering and conditional queuing</span><br><span class="token comment">// This is illustrative and not direct code, as the actual logic is more intricate.</span><br><span class="token keyword">match</span> value_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">TraversalEvent</span><span class="token punctuation">::</span><span class="token class-name">Descend</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> field_name<span class="token punctuation">,</span> field_schema <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><span class="token comment">// ... push context onto stacks ...</span><br><span class="token comment">// Check for missing fields within 'value' based on 'field_schema'</span><br><span class="token keyword">let</span> missing_fields <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">find_missing_paths</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> field_schema<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">self</span><span class="token punctuation">.</span>buffered_missing<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>missing_fields<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">self</span><span class="token punctuation">.</span>work_queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token class-name">WorkItem</span><span class="token punctuation">::</span><span class="token class-name">Value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Process the present value</span><br><span class="token punctuation">}</span><br><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">TraversalEvent</span><span class="token punctuation">::</span><span class="token class-name">Ascend</span> <span class="token punctuation">{</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">TraversalEvent</span><span class="token punctuation">::</span><span class="token class-name">NextSibling</span> <span class="token punctuation">{</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><span class="token comment">// When ascending or moving to a sibling, now is the time to</span><br><span class="token comment">// inject buffered missing fields into the work_queue</span><br><span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>missing_field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>buffered_missing<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><span class="token keyword">self</span><span class="token punctuation">.</span>work_queue<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span><span class="token class-name">WorkItem</span><span class="token punctuation">::</span><span class="token class-name">MissingField</span><span class="token punctuation">(</span>missing_field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token comment">// ... pop context from stacks ...</span><br><span class="token punctuation">}</span><br><span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
<hr>
<h2 id="the-next()-method:-orchestrating-the-shredding" tabindex="-1">The <code>next()</code> Method: Orchestrating the Shredding <a class="direct-link" href="#the-next()-method:-orchestrating-the-shredding" aria-hidden="true">#</a></h2>
<p>The <strong>ValueParser</strong> implements the <code>Iterator</code> trait, making it a highly ergonomic way to consume shredded records. Its
<code>next()</code> method is the heart of the orchestration.</p>
<h3 id="iterator-implementation" tabindex="-1">Iterator Implementation <a class="direct-link" href="#iterator-implementation" aria-hidden="true">#</a></h3>
<p>By implementing <code>Iterator&lt;Item = ShreddedRecord&gt;</code>, <strong>ValueParser</strong> allows you to simply call <code>parser.next()</code> to get the
next shredded piece of data (value, definition level, repetition level).</p>
<h3 id="the-main-loop" tabindex="-1">The Main Loop <a class="direct-link" href="#the-main-loop" aria-hidden="true">#</a></h3>
<p>The control flow within <code>ValueParser::next()</code> is carefully designed:</p>
<ul>
<li><strong>Prioritize <code>work_queue</code></strong>: The parser first checks its <code>work_queue</code>. If there are items (either actual values or
buffered missing fields), it processes the next one and returns the corresponding shredded record. This ensures that
previously identified and buffered missing fields are emitted at the correct time.</li>
<li><strong>Pull from <code>value_iter</code> if <code>work_queue</code> is empty</strong>: If the <code>work_queue</code> is empty, it means all pending items have
been processed. The parser then pulls the next present value (or traversal event) from <code>value_iter</code>.</li>
<li><strong>Conditional Buffering/Queuing</strong>: Based on the <code>TraversalEvent</code> from <code>value_iter</code> (descending into a new field,
ascending, or moving to a sibling):
<ul>
<li><strong>Descending</strong>: The parser might identify new missing paths and buffer them. The present value is typically
immediately added to the <code>work_queue</code>.</li>
<li><strong>Backtracking (Ascending or NextSibling)</strong>: This is the critical moment. Any previously buffered missing paths that
are now &quot;complete&quot; (i.e., we've fully processed or visited all children of the current node) are moved from the
internal buffer to the <strong>front</strong> of the <code>work_queue</code>. This ensures they are processed before moving further up the
tree or to the next sibling, maintaining correct order.</li>
</ul>
</li>
</ul>
<p>Here's a simplified, high-level view of <code>ValueParser::next</code>'s loop:</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// Simplified high-level pseudo-code for ValueParser::next()</span><br><span class="token keyword">impl</span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">ValueParser</span> <span class="token punctuation">{</span><br>  <span class="token keyword">type</span> <span class="token type-definition class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">ShreddedRecord</span><span class="token punctuation">;</span> <span class="token comment">// (Value, DefLevel, RepLevel)</span><br><br>  <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span> <span class="token punctuation">{</span><br>    <span class="token comment">// 1. Prioritize work_queue</span><br>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>work_item<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>work_queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process_work_item</span><span class="token punctuation">(</span>work_item<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Process and return shredded record</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// 2. If work_queue is empty, pull from value_iter</span><br>    <span class="token keyword">loop</span> <span class="token punctuation">{</span><br>      <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token comment">// Get next event from the actual value traversal</span><br>        <span class="token class-name">TraversalEvent</span><span class="token punctuation">::</span><span class="token class-name">Descend</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> field_schema<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>          <span class="token comment">// Update contexts (def/rep levels, struct context)</span><br>          <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_contexts_for_descent</span><span class="token punctuation">(</span>field_schema<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>          <span class="token comment">// Find and buffer any missing fields based on schema and 'value'</span><br>          <span class="token keyword">let</span> missing <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">find_missing_paths</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">,</span> field_schema<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token keyword">self</span><span class="token punctuation">.</span>buffered_missing<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>missing<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>          <span class="token comment">// Add the present value to the work queue to be processed</span><br>          <span class="token keyword">self</span><span class="token punctuation">.</span>work_queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token class-name">WorkItem</span><span class="token punctuation">::</span><span class="token class-name">Value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// Exit loop, process work_queue on next `next()` call</span><br>        <span class="token punctuation">}</span><br>        <span class="token class-name">TraversalEvent</span><span class="token punctuation">::</span><span class="token class-name">Ascend</span> <span class="token punctuation">{</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token class-name">TraversalEvent</span><span class="token punctuation">::</span><span class="token class-name">NextSibling</span> <span class="token punctuation">{</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>          <span class="token comment">// Update contexts (pop levels)</span><br>          <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update_contexts_for_ascend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>          <span class="token comment">// If ascending or moving to a sibling, inject buffered missing fields</span><br>          <span class="token comment">// for the current level to the *front* of the work_queue</span><br>          <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>missing_field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>buffered_missing<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">self</span><span class="token punctuation">.</span>work_queue<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span><span class="token class-name">WorkItem</span><span class="token punctuation">::</span><span class="token class-name">MissingField</span><span class="token punctuation">(</span>missing_field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><br><br>          <span class="token comment">// If work_queue now has items, break to process them.</span><br>          <span class="token comment">// Otherwise, continue loop to get next value_iter event.</span><br>          <span class="token keyword">if</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>work_queue<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">break</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        <span class="token comment">// ... other traversal events</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// After the loop, the work_queue should have items to process.</span><br>    <span class="token comment">// Recursively call next() to process the now-populated work_queue,</span><br>    <span class="token comment">// ensuring the first item is emitted.</span><br>    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<hr>
<h2 id="putting-it-all-together:-a-concrete-example" tabindex="-1">Putting It All Together: A Concrete Example <a class="direct-link" href="#putting-it-all-together:-a-concrete-example" aria-hidden="true">#</a></h2>
<p>Let's illustrate denester's power with a real test case that specifically demonstrates handling missing data within a
repeated struct. We'll use a simplified version of <code>test_repeated_struct_with_missing_values</code> from <code>tests/parser.rs</code>.</p>
<h3 id="illustrative-test-case" tabindex="-1">Illustrative Test Case <a class="direct-link" href="#illustrative-test-case" aria-hidden="true">#</a></h3>
<p>Consider this schema for a document with optional tags:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"doc"</span><span class="token punctuation">,</span><br>  <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span><br>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"INT32"</span><span class="token punctuation">,</span><br>      <span class="token property">"repetition"</span><span class="token operator">:</span> <span class="token string">"REQUIRED"</span><span class="token punctuation">,</span><br>      <span class="token property">"def_level"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>      <span class="token property">"rep_level"</span><span class="token operator">:</span> <span class="token number">0</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tags"</span><span class="token punctuation">,</span><br>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"LIST"</span><span class="token punctuation">,</span><br>      <span class="token property">"repetition"</span><span class="token operator">:</span> <span class="token string">"OPTIONAL"</span><span class="token punctuation">,</span><br>      <span class="token property">"def_level"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>      <span class="token property">"rep_level"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>      <span class="token property">"children"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>        <span class="token punctuation">{</span><br>          <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"list"</span><span class="token punctuation">,</span><br>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"GROUP"</span><span class="token punctuation">,</span><br>          <span class="token property">"repetition"</span><span class="token operator">:</span> <span class="token string">"REPEATED"</span><span class="token punctuation">,</span><br>          <span class="token property">"def_level"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><br>          <span class="token property">"rep_level"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>          <span class="token property">"children"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>            <span class="token punctuation">{</span><br>              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span><br>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"BYTE_ARRAY"</span><span class="token punctuation">,</span><br>              <span class="token property">"repetition"</span><span class="token operator">:</span> <span class="token string">"REQUIRED"</span><span class="token punctuation">,</span><br>              <span class="token property">"def_level"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><br>              <span class="token property">"rep_level"</span><span class="token operator">:</span> <span class="token number">2</span><br>            <span class="token punctuation">}</span><span class="token punctuation">,</span><br>            <span class="token punctuation">{</span><br>              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"value"</span><span class="token punctuation">,</span><br>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"BYTE_ARRAY"</span><span class="token punctuation">,</span><br>              <span class="token property">"repetition"</span><span class="token operator">:</span> <span class="token string">"OPTIONAL"</span><span class="token punctuation">,</span><br>              <span class="token property">"def_level"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><br>              <span class="token property">"rep_level"</span><span class="token operator">:</span> <span class="token number">2</span><br>            <span class="token punctuation">}</span><br>          <span class="token punctuation">]</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="input-and-expected-output" tabindex="-1">Input and Expected Output <a class="direct-link" href="#input-and-expected-output" aria-hidden="true">#</a></h3>
<p>Input JSON (represented as <code>denester::Value</code>):</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span><br>  <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tagA"</span><span class="token punctuation">,</span><br>      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"val1"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tagB"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token comment">// "value" field is missing here</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tagC"</span><span class="token punctuation">,</span><br>      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"val3"</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
<p>Expected Shredded Output (Value, Def Level, Rep Level):</p>
<pre><code>(123,           1, 0)  // id
(b&quot;tagA&quot;,      3, 0)  // tags.list.name
(b&quot;val1&quot;,      3, 0)  // tags.list.value
(b&quot;tagB&quot;,      3, 1)  // tags.list.name
(NULL,          2, 1)  // tags.list.value (missing, note def_level decreased)
(b&quot;tagC&quot;,      3, 1)  // tags.list.name
(b&quot;val3&quot;,      3, 1)  // tags.list.value
</code></pre>
<h3 id="walkthrough" tabindex="-1">Walkthrough <a class="direct-link" href="#walkthrough" aria-hidden="true">#</a></h3>
<ol>
<li><strong>id</strong>: Processed first, straightforward.</li>
<li><strong>tags (list start)</strong>: <strong>ValueParser</strong> descends into the tags list.</li>
<li><strong>tags[0] (tagA)</strong>:</li>
</ol>
<ul>
<li><strong>name</strong>: &quot;tagA&quot; is processed.</li>
<li><strong>value</strong>: &quot;val1&quot; is processed.</li>
</ul>
<ol start="4">
<li><strong>tags[1] (tagB)</strong>:</li>
</ol>
<ul>
<li><strong>name</strong>: &quot;tagB&quot; is processed (repetition level increments as it's a new element in the list).</li>
<li>Now, the <strong>ValueParser</strong> notices that the <code>value</code> field is missing for <code>tagB</code> in the input <strong>Value</strong>. It identifies
this gap against the schema.</li>
<li>It buffers this missing <code>value</code> field internally.</li>
<li>As the <code>value_iter</code> signals it's moving from <code>tagB</code> to <code>tagC</code> (a sibling), the buffered <code>value</code> missing field is
pushed to the <strong>front</strong> of the <code>work_queue</code>.</li>
<li>When <code>ValueParser::next()</code> is called again, it prioritizes the <code>work_queue</code> and emits <code>(NULL, 2, 1)</code> for the missing
<code>value</code> field. The definition level <code>2</code> correctly indicates that the optional <code>value</code> field itself is missing, but its
parent list and group are present.</li>
</ul>
<ol start="5">
<li><strong>tags[2] (tagC)</strong>:</li>
</ol>
<ul>
<li><strong>name</strong>: &quot;tagC&quot; is processed.</li>
<li><strong>value</strong>: &quot;val3&quot; is processed.</li>
</ul>
<p>This example clearly shows how <strong>ValueParser</strong> strategically buffers and then emits nulls for missing optional fields at
precisely the right moment, ensuring columnar correctness.</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// tests/parser.rs - (Simplified and illustrative snippet)</span><br><span class="token attribute attr-name">#[test]</span><br><span class="token keyword">fn</span> <span class="token function-definition function">test_repeated_struct_with_missing_values</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> schema <span class="token operator">=</span> <span class="token class-name">SchemaBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">add_field</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">Int32</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">add_field</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"tags"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><br>      <span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">Group</span><span class="token punctuation">(</span><br>        <span class="token class-name">SchemaBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>          <span class="token punctuation">.</span><span class="token function">add_field</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>          <span class="token punctuation">.</span><span class="token function">add_field</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token class-name">DataType</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Optional value</span><br>          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> input_value <span class="token operator">=</span> <span class="token class-name">ValueBuilder</span><span class="token punctuation">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">Int32</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"tags"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><br>      <span class="token class-name">ValueBuilder</span><span class="token punctuation">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"tagA"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"val1"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token class-name">ValueBuilder</span><span class="token punctuation">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"tagB"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Missing "value" field</span><br>      <span class="token class-name">ValueBuilder</span><span class="token punctuation">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"tagC"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"val3"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> <span class="token keyword">mut</span> parser <span class="token operator">=</span> <span class="token class-name">ValueParser</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> expected_output <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><br>    <span class="token comment">// (Value, Def Level, Rep Level)</span><br>    <span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">Int32</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// id</span><br>    <span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"tagA"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// tags.list.name</span><br>    <span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"val1"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// tags.list.value</span><br>    <span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"tagB"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// tags.list.name</span><br>    <span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">Null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// tags.list.value (missing)</span><br>    <span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"tagC"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// tags.list.name</span><br>    <span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token string">b"val3"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// tags.list.value</span><br>  <span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span>expected_value<span class="token punctuation">,</span> expected_def<span class="token punctuation">,</span> expected_rep<span class="token punctuation">)</span> <span class="token keyword">in</span> expected_output <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> <span class="token punctuation">(</span>shredded_value<span class="token punctuation">,</span> def_level<span class="token punctuation">,</span> rep_level<span class="token punctuation">)</span> <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>shredded_value<span class="token punctuation">,</span> expected_value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>def_level<span class="token punctuation">,</span> expected_def<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>rep_level<span class="token punctuation">,</span> expected_rep<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token macro property">assert!</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Ensure no more values</span><br><span class="token punctuation">}</span></code></pre>
<hr>
<h2 id="conclusion" tabindex="-1">Conclusion <a class="direct-link" href="#conclusion" aria-hidden="true">#</a></h2>
<p>denester's Rust implementation provides a robust and correct solution for &quot;shredding&quot; complex, sparse nested data,
directly addressing the intricate challenges posed by Dremel's algorithm. The chosen architecture, featuring a decoupled
<strong>DepthFirstValueIterator</strong>, an explicit state machine within <strong>ValueParser</strong>, and the strategic use of a <code>work_queue</code>,
ensures:</p>
<ul>
<li><strong>Robustness</strong>: It handles arbitrary nesting and complex scenarios, including deeply nested optional and repeated
fields.</li>
<li><strong>Correctness</strong>: It accurately computes definition and repetition levels, crucially inserting &quot;synthetic&quot; nulls for
missing data in the correct order.</li>
<li><strong>Maintainability</strong>: The separation of concerns between traversal and processing, along with clear state management,
makes the codebase understandable and extendable.</li>
</ul>
<p>This pattern of using a decoupled iterator and an explicit state machine with a work queue is not unique to record
shredding. It holds significant value for other complex tree transformations and data processing pipelines in Rust,
where fine-grained control over output order and the handling of inferred or synthetic data is required.</p>
<p>We invite you to explore
the <a href="https://www.google.com/search?q=https://github.com/your-repo-link">denester repository on GitHub</a> to dive deeper
into the code and see this architecture in action. Feel free to contribute or open issues if you find areas for
improvement!</p>


      </main>

      <footer></footer>

      <!-- Current page: /posts/2025-06-18-rust-iterator-state-machine-record-shredding/ -->
    </body>
  </div>
</html>
